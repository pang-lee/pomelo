<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Pomelo</title>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <meta http-equiv="content-style-type" content="text/css" />
    <meta http-equiv="content-scripte-type" content="text/javascript" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" >
    <meta name="theme-color" content="#FFE1C4" />
    <meta name="author" content="netease" />
    <meta name="version" content="1.0" />
    <meta name="keywords" content="pomelo" />
    <meta name="theme-color"/>
    <link type="text/css" rel="stylesheet" href="css/base.css" />
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/image/icon/icon-96x96.png"/>
    <meta name="apple-mobile-web-app-status-bar" content="#aa7700"/>
    <script src="js/app.js"></script>
    <script src="js/lib/socket.io.js"></script>
    <script src="js/lib/pomeloclient.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css"/>
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css"/>
    <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>
    <script src="https://unpkg.com/vue-router/dist/vue-router.js"></script>
    <script src="https://unpkg.com/vuex"></script>
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.js"></script>
    <script src="/js/vue/component/component.js"></script>    
    <script src="/js/vue/vuex.js"></script>
    <script src="/js/vue/router.js"></script>
    <script src="/js/vue/vue.js"></script>
    <script type="text/javascript">
      var pomelo = window.pomelo;
      var host = "127.0.0.1";
      var port = "3010";
      function show() {
        pomelo.init({
          host: host,
          port: port,
          log: true
        }, function() {
        pomelo.request("connector.entryHandler.entry", "hello pomelo", function(data) {
            alert(data.msg);
          });
        });
      }
    </script>
  </head>
  <body>
    <div id="app">
      <navbar></navbar>
      <h1>Hello from outside</h1>      
      <router-view></router-view>
    </div>
    <div class="recipe"></div>
    <div>
      <form>
        <p>Name:</p>
        <p><input id="title" type="text" name="name" value="你的名字"></p>
        <p>Email:</p>
        <p><input id="ingredient" name="species" type="text"></p>
        <p><input type="submit" value="送出資料"></p>
      </form>
    </div>
  </body>

  <script src="https://www.gstatic.com/firebasejs/7.19.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.19.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.19.0/firebase-analytics.js"></script>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyDjCY3KmtAfrvYzH-d6jXeBWnTFLSICIfA",
      authDomain: "pomelo-a53a7.firebaseapp.com",
      databaseURL: "https://pomelo-a53a7.firebaseio.com",
      projectId: "pomelo-a53a7",
      storageBucket: "pomelo-a53a7.appspot.com",
      messagingSenderId: "510530322503",
      appId: "1:510530322503:web:a1f9199b4b52b380c13162",
      measurementId: "G-ZDNE5QY46N"
    }

    firebase.initializeApp(firebaseConfig)
    firebase.analytics()
    const db = firebase.firestore()

    const renderRecipe = (data, id) => {
      document.querySelector('.recipe').innerHTML += `
      <div class="datarecipe" data-id="${id}">
        <div>${data.title}</div>
        <div>${data.ingredient}</div>
        <i data-id="${id}">delete</i>
      </div>`
    }

    const removeRecipe = (id) => {
      const recipe = document.querySelector(`.datarecipe[data-id=${id}]`)
      recipe.remove()
    }

    db.enablePersistence().catch((error) => {
      if(error.code === 'failed-precondition') console.log("presistence fail")
      else if(error.code === 'unimplemented') console.log('presistence is not avaliable')
    })

    db.collection('recipe').onSnapshot((snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if(change.type === 'added'){
          renderRecipe(change.doc.data(), change.doc.id)
        }else if(change.type === 'removed'){
          removeRecipe(change.doc.id)
        }
      })
    })

    const form = document.querySelector('form')
    form.addEventListener('submit', (evt) => {
      evt.preventDefault();
      const insert = {
        title: form.title.value,
        ingredient: form.ingredient.value
      }

    db.collection('recipe').add(insert).catch((err) => console.log(err))
      form.title.value = ''
      form.ingredient.value = ''
    })

    const recipeContainer = document.querySelector('.recipe')
    recipeContainer.addEventListener('click', (evt) => {
      if(evt.target.tagName === 'I'){
        const id = evt.target.getAttribute('data-id')
        db.collection('recipe').doc(id).delete();
      }
    })
  </script>

</html>
